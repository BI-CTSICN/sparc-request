-@service_requests.each do |service_request|
  - service_request.arms.each do |arm|
    .arm_calendar_container{:'data-arm_id' => arm.id}
      - next if arm.visit_groups.empty?
      = render :partial => 'calendar_data', :locals => {:tab => @tab, :arm => arm, :service_request => service_request}
- if (@sub_service_request.nil? ? @service_request.has_one_time_fee_services? : @sub_service_request.has_one_time_fee_services?) and !@portal
  %table.service_calendar
    %thead.ui-widget-header
      %tr.table_header
        %th{:rowspan => 2, :style => "height: 88px"}= t("calendar_page.headers.services")
        - if @portal 
          %th{:rowspan => 2, :colspan => 7, :height => 40, :width => 375}
        -else
          %th{:colspan => 2}= t("calendar_page.headers.unit_costs")
          %th{:rowspan => 2}= t("calendar_page.headers.qty_type")
          %th{:rowspan => 2}= t("calendar_page.headers.number_of_units")
          %th{:rowspan => 2}= t("calendar_page.headers.qty_unit")
          %th{:rowspan => 2, :colspan => 5, :height => 40, :width => 375}

        %th= image_tag 'spinner.gif', :class => 'service_calendar_spinner'

      %tr.table_header
        - unless @portal
          %th= t("calendar_page.headers.service_rate")
          %th= t("calendar_page.headers.your_cost")
        - if @portal
          %th &nbsp;
        - else
          %th= t("calendar_page.headers.total_per_study")

    %tbody.cell-border
      %tr.section_header
        %th{:colspan => 12}
          = t("calendar_page.headers.other_services")
          #one_time_fee_errors{:style => 'display:none;'}
            = t(:service_requests)[:detail_list][:text1]
            %span#quantity
            = t(:service_requests)[:detail_list][:text2]
            %span#unit_minimum 
            %br
            = t(:service_requests)[:detail_list][:text3]
            
          #unit_max_error{:style => 'display:none;'}
            = t(:service_requests)[:detail_list][:text4]
            %span#unit_quantity
            = t(:service_requests)[:detail_list][:text5]
            %span#unit_max
            %br       
            = t(:service_requests)[:detail_list][:text6]
      - @service_request.service_list(true).each do |key, value| # get only one time fee services and group them
        - next unless @sub_service_request.nil? or @sub_service_request.organization.name == value[:process_ssr_organization_name]
        %tr.sub_section_header
          %th.otf{:colspan => 12}= value[:name]
          - value[:line_items].each do |line_item|
            %tr.line_item.otfs{:class => cycle('odd', '', :name => 'otfs')}
              %td.service_name
                = line_item.service.name
                = hidden_field_tag "service_request[line_items_attributes][#{line_item.id}][id]", line_item.id
              %td{:class => "service_rate_#{line_item.id}"}= display_service_rate line_item
              %td.your_cost{:"data-your_cost" => line_item.applicable_rate}= display_your_cost line_item
              %td= line_item.service.try(:displayed_pricing_map).try(:unit_type).try(:humanize)
              %td= text_field_tag "service_request[line_items_attributes][#{line_item.id}][quantity]", line_item.quantity, |
                   :unit_minimum => line_item.service.displayed_pricing_map.unit_minimum, :class => 'line_item_quantity', :current_quantity => line_item.quantity |
              -#
              %td= text_field_tag "service_request[line_items_attributes][#{line_item.id}][units_per_quantity]", line_item.units_per_quantity, | 
                   "data-qty_max" => line_item.service.displayed_pricing_map.units_per_qty_max, :class => "units_per_quantity" |
              %td{:colspan => 5}
              %td{:class => "otf_total total_#{line_item.id}"}= display_one_time_fee_direct_cost line_item

      %tr.totals_section.begin_totals{:class => cycle('odd', '', :name => 'otfs')}
        %td{:colspan => 5}= t("calendar_page.labels.total_direct_other")
        %td{:colspan => 6}
        %td.otf_total_direct_cost= display_total_direct_cost_per_study_otfs @service_request, @line_items
